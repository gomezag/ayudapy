{% extends 'base.html' %}

{% block title %} Pedido #{{help_request.id}} {% endblock %} 

{% block fb-title %} Pedido #{{help_request.id}} - {{ help_request.title}} {% endblock %} 
{% block fb-description %} {{help_request.message}} {% endblock %} 
{% block fb-image %} {{thumbnail}} {% endblock %} 

{% load leaflet_tags %} 
{% load static %}
{% load l10n %}
{% load humanize %}
{% block bread %}
  <nav class="breadcrumb  has-arrow-separator" aria-label="breadcrumbs">
    <ul>
        <li>
            <span class="icon is-small">
                <i class="fas fa-home" aria-hidden="true"></i>
                </span>
            <li><a href="/">Inicio</a></li>
            <li><a href="/dar">Info ayudar</a></li>
            <li><a href="/pedidos">Pedidos de ayuda</a></li>
            <li class="is-active"><a href="#" aria-current="page">Pedido #{{help_request.id}}</a></li>
        </ul>
    </nav>
{% endblock bread %}
{% block content%}
{% include 'captcha.html' %}
<div class="columns is-centered">
    <div class="column is-half">
      {% if messages %}
        {% for message in messages %}
            <div class="notification is-success is-half" id='msg{{ forloop.counter }}'>
                <button class="delete" onclick="document.getElementById('msg{{ forloop.counter }}').style.display = 'none';"></button>
                    <span class="is-5">{{ message }}Se creó tu pedido exitosamente!</span>
                    <p><span class="icon is-medium"><i class="far fa-hand-point-down"></i></span>
                    Podés compartir tu pedido haciendo click en los botones</p>
            {% include 'includes/buttons.html'%}
            </div>
        {% endfor %}
      {% endif %}
        <div class="subtitle center is-3">
        <a class="has-text-primary" href="/pedidos/{{help_request.id}}">Pedido #{{help_request.id}}</a>
        </div>
    </div>
</div>
<div class="columns is-centered">
    <div class="column is-four-fifths">

        <div class="card">
        <header class="card-header has-background-light is-light">
            <p class="card-header-title is-size-4">{{ help_request.title}}</p>
        </header>
        <section class="card-content">
                    <p class="has-text-right is-size-7" title="{{help_request.added|naturaltime}}">{{help_request.added}}</p>
                    <p class="is-size-5">{{help_request.message|linebreaksbr}}</p>
                    {% if help_request.picture %}
                    <hr>
                      <figure class="image is-small"> 
                        <a href="/media/{{help_request.picture}}">
                          <img class="has-ratio" src="{{thumbnail}}"/>
                        </a>
                      </figure>
                    {% endif %}
                    <hr>
                    <p class="subtitle">Nombre:</p>
                    <p class="title is-4">{{ help_request.name}}</p>
                    <p class="subtitle">Contacto:</p>
                    <span id="contact"></span>
                    <button class="button is-small is-center" onclick="show_captcha();">Ver contacto</button>
                    {% if help_request.address %}
                      <p class="subtitle">direccion:</p>
                      <p class="title is-4">{{help_request.address}}</p>
                    {% endif %}
                    <p class="subtitle">Ciudad: </p>
                    <p class="title is-4">
                        <a href="/pedidos_ciudad/{{help_request.city_code}}">{{help_request.city}}</a>
                    </p>
                     <p class="subtitle">Ubicación:
                     {% leaflet_map "main" callback="main_map_init" %}
                     </p>
                     <a href="https://www.google.com/maps/search/?api=1&query={{help_request.location.y|unlocalize}},{{help_request.location.x|unlocalize}}" target="_blank">
                       <button class="button is-medium is-fullwidth is-link is-light">
                            <span class="icon is-medium">
                            <i class="fas fa-map-marker-alt"></i>
                            </span>
                            <span>Abrir en Google Maps</span>
                        </button>
                     </a>

        </section>
                    {% include 'vote_button.html' %}
    </div>

                {% comment %} <article class="tile is-child is-box">
                    <p class="title is-4">{{ help_request.title}}</p>
                    <p class="subtitle">{{help_request.message|linebreaks}}</p>
                    <hr>
                    <p class="subtitle">Nombre:</p>
                    <p class="title is-4">{{ help_request.name}}</p>
                    <p class="subtitle">Contacto:</p>
                        <a></a>
                    {% if help_request.address %}
                      <p class="subtitle">Dirección:</p>
                      <p class="title is-4">{{help_request.address}}</p>
                    {% endif %}
                    {% if help_request.picture %}
                      <figure class="image is-small"> 
                        <a href="/media/{{help_request.picture}}">
                          <img class="has-ratio" src="{{thumbnail}}"/>
                        </a>
                      </figure>
                    {% endif %}
                     <p class="subtitle">Ubicación:
                     {% leaflet_map "main" callback="main_map_init" %}
                     </p>
                     <a href="https://www.google.com/maps/search/?api=1&query={{help_request.location.y|unlocalize}},{{help_request.location.x|unlocalize}}" target="_blank">
                       <button class="button is-medium is-fullwidth is-link is-light">
                            <span class="icon is-medium">
                            <i class="fas fa-map-marker-alt"></i>
                            </span>
                            <span>Abrir en Google Maps</span>
                        </button>
                     </a>
                </article> {% endcomment %}
                <hr>
                <label class="label has-text-success">
                    <span class="icon is-medium"><i class="far fa-hand-point-down"></i></span>
                        Podés compartir este pedido haciendo click en los botones
                    </label>
                <div class="is-fullwidth">
                {% include 'includes/buttons.html'%}
                </div>
          

        

        <script type="text/javascript">
            function main_map_init(map, options) {
                // Use Leaflet API here
                {% autoescape off %}
                var lon = {{ help_request.location.x|unlocalize }};
                var lat = {{ help_request.location.y|unlocalize }};
                data = {{ help_request.location.geojson }}
                {% endautoescape %}
                    // zoom to point & add it to map
                map.setView([lat, lon], 14);
                //L.marker([lat, lon]).addTo(map);
                L.geoJson(data).addTo(map)
            }

            function show_captcha() {
                document.getElementById('captcha').classList.toggle('is-active');
            }

            function get_contact_info(el) {
                document.getElementById('captcha').classList.remove('is-active');
              var v= grecaptcha.getResponse();

              var xhttp = new XMLHttpRequest();

              xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById('contact').innerHTML=this.responseText;
                }
              };
              xhttp.open("POST", {{help_request.id}}, true);
              xhttp.setRequestHeader("X-CSRFToken","{{csrf_token}}");
              xhttp.setRequestHeader("Content-type", "application/json");
              var data = JSON.stringify({"g-recaptcha-response":v});
              xhttp.send(data);
            }
        </script>
    </div>
</div>
{% endblock %}